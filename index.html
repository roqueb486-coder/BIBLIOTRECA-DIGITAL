<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Biblioteca Digital - IEP San Luis Gonzaga Huánuco"/>
  <title>Biblioteca Digital Sanluisina | IEP San Luis Gonzaga - Huánuco</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&family=Playfair+Display:wght@700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>

  <style>
    :root {
      --primary: #003087;
      --secondary: #0146c6ff;
      --accent: #FFD700;
      --light: #f8f9fa;
      --dark: #1e293b;
      --gray: #64748b;
      --gray-light: #e2e8f0;
      --success: #10b981;
      --danger: #ef4444;
      --card-shadow: 0 8px 25px rgba(0,48,135,0.12);
      --card-shadow-hover: 0 25px 50px rgba(0,48,135,0.22);
      --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      --radius: 20px;
      --radius-sm: 14px;
    }

    [data-theme="dark"] {
      --light: #0f172a;
      --dark: #000000ff;
      --gray: #94a3b8;
      --gray-light: #334155;
      --card-shadow: 0 8px 25px rgba(0,48,135,0.35);
      --card-shadow-hover: 0 30px 60px rgba(0,48,135,0.5);
    }

    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--light);
      color: var(--dark);
      line-height: 1.6;
      transition: var(--transition);
      overflow-x: hidden;
      padding-left: 280px;
    }

    /* ===== SIDEBAR IZQUIERDO ===== */
    .sidebar { position: fixed; left: 0; top: 0; width: 280px; height: 100vh; background: linear-gradient(180deg, var(--primary), var(--secondary)); color: white; z-index: 999; display: flex; flex-direction: column; box-shadow: 8px 0 30px rgba(0,48,135,0.3); overflow-y: auto; }
    .sidebar-header { padding: 2.8rem 1.5rem 2.2rem; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.15); }
    .sidebar-logo-big { width: 158px; height: auto; max-width: 80%; filter: drop-shadow(0 8px 20px rgba(0,0,0,0.6)); margin-bottom: 16px; border-radius: 22px; background: rgba(255,255,255,0.18); padding: 14px; backdrop-filter: blur(6px); }
    .sidebar-header h2 { font-family: 'Playfair Display', serif; font-size: 1.85rem; margin:0; line-height:1.2; }
    .sidebar-header span { font-size:1.35rem; opacity:0.95; }
    .sidebar-nav { flex:1; padding:1.8rem 0; }
    .nav-item { display:flex; align-items:center; gap:16px; padding:1.1rem 2rem; color:rgba(255,255,255,0.92); text-decoration:none; font-weight:500; transition:all 0.35s; position:relative; }
    .nav-item i { font-size:1.35rem; width:30px; }
    .nav-item:hover { background:rgba(255,255,255,0.18); padding-left:2.4rem; }
    .nav-item.active { background:rgba(255,255,255,0.28); font-weight:700; border-left:6px solid var(--accent); padding-left:2.4rem; }
    .sidebar-footer { padding:1.6rem; text-align:center; font-size:0.92rem; opacity:0.85; border-top:1px solid rgba(255,255,255,0.15); }

    .hero { height:100vh; min-height:620px; background:linear-gradient(rgba(0,48,135,0.95), rgba(0,48,135,0.88)), url('https://images.unsplash.com/photo-1507842217343-583bb7270b66?w=1920') center/cover; display:flex; align-items:center; justify-content:center; text-align:center; color:white; }
    .hero-content { display:flex; flex-direction:column; align-items:center; gap:20px; }
    .hero-logo-big { width:190px; filter:drop-shadow(0 10px 25px rgba(0,0,0,0.7)); margin-bottom:-8px; }
    .hero-content h1 { font-family:'Playfair Display',serif; font-size:clamp(3rem,8vw,5.8rem); margin:0; text-shadow:0 8px 20px rgba(0,0,0,0.6); font-weight:900; }
    .search-bar input { padding:18px 30px; width:100%; max-width:600px; border:none; border-radius:50px; font-size:1.15rem; box-shadow:0 15px 40px rgba(0,48,135,0.5); outline:none; }
    .container { max-width:1400px; margin:0 auto; padding:0 30px; }

    .cards { display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:1.8rem; padding:2rem 0; }
    .card { background:white; border-radius:20px; overflow:hidden; box-shadow:var(--card-shadow); transition:all 0.45s ease; position:relative; border:3px solid var(--accent); opacity:0; transform:translateY(35px); }
    .card.visible { opacity:1; transform:translateY(0); }
    .card:hover { transform:translateY(-14px); box-shadow:var(--card-shadow-hover); }
    .card img { width:100%; height:170px; object-fit:cover; transition:transform 0.6s ease; }
    .card:hover img { transform:scale(1.08); }
    .content { padding:1.4rem 1.3rem 1.3rem; }
    .category-badge { background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white; padding:8px 14px; border-radius:50px; font-size:0.73rem; font-weight:700; letter-spacing:0.5px; display:inline-block; margin-bottom:12px; text-transform:uppercase; }
    .card h3 { font-family:'Playfair Display',serif; font-size:1.38rem; font-weight:800; color:#1e293b; margin:8px 0 10px; line-height:1.26; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .card p:nth-of-type(1) { font-size:0.98rem; font-weight:600; color:var(--primary); margin-bottom:8px; display:flex; align-items:center; gap:8px; }
    .card p:nth-of-type(1)::before { content:"Star"; color:var(--accent); font-size:1.2rem; }
    .card p:last-of-type { font-size:0.92rem; color:#555; font-style:italic; line-height:1.55; margin:14px 0 16px; padding:0 4px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; opacity:0.92; }
    .action-buttons { display:flex; flex-direction:column; gap:10px; margin-top:14px; }
    .read-btn,.download-btn { border-radius:14px; font-weight:600; transition:all 0.35s ease; display:flex; align-items:center; justify-content:center; gap:10px; font-size:0.94rem; padding:11px 16px; letter-spacing:0.4px; }
    .read-btn { background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white; border:none; box-shadow:0 6px 20px rgba(0,48,135,0.35); cursor:pointer; }
    .read-btn:hover { transform:translateY(-3px); box-shadow:0 12px 30px rgba(0,48,135,0.5); }
    .download-btn { background:#dc2626; color:white; text-decoration:none; box-shadow:0 6px 20px rgba(220,38,38,0.35); }
    .download-btn:hover { background:#b91c1c; transform:translateY(-3px); box-shadow:0 12px 30px rgba(220,38,38,0.5); }
    .favorite-btn { position:absolute; top:14px; right:14px; width:42px; height:42px; background:white; border:3px solid #e2e8f0; border-radius:50%; font-size:1.2rem; color:#94a3b8; z-index:10; transition:all 0.35s ease; box-shadow:0 6px 18px rgba(0,0,0,0.12); display:flex; align-items:center; justify-content:center; }
    .favorite-btn.active { color:#ef4444; border-color:#fca5a5; background:#fff5f5; animation:heartbeat 0.9s ease-in-out; }
    .favorite-btn:hover { transform:scale(1.12); border-color:#ef4444; }

    @keyframes heartbeat { 0%,100%{transform:scale(1)} 15%{transform:scale(1.3)} 30%{transform:scale(1)} 45%{transform:scale(1.25)} 70%{transform:scale(1)} }

    .stats { display:flex; justify-content:center; gap:3rem; padding:3.5rem 2rem; background:white; margin:2.5rem 0; border-radius:var(--radius); box-shadow:var(--card-shadow); flex-wrap:wrap; }
    .stat-item h3 { font-size:2.8rem; background:linear-gradient(to right,var(--primary),var(--accent)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-weight:900; }
    .filters { background:white; padding:1.8rem; border-radius:var(--radius); box-shadow:var(--card-shadow); margin-bottom:2.5rem; display:flex; flex-wrap:wrap; gap:1.2rem; align-items:end; }
    .section-title { grid-column:1/-1; margin:3rem 0 1.5rem; font-size:2rem; color:var(--primary); font-weight:800; border-bottom:4px solid var(--primary); padding-bottom:10px; display:inline-block; }
    .controls { position:fixed; top:90px; right:20px; z-index:999; display:flex; flex-direction:column; gap:16px; }
    .control-btn { width:56px; height:56px; border-radius:50%; background:var(--primary); color:white; border:none; cursor:pointer; box-shadow:0 6px 20px rgba(0,48,135,0.35); font-size:1.35rem; }
    #scrollTop { position:fixed; bottom:30px; right:30px; width:58px; height:58px; background:var(--primary); color:white; border:none; border-radius:50%; font-size:1.7rem; cursor:pointer; box-shadow:0 8px 25px rgba(0,48,135,0.4); opacity:0; visibility:hidden; transition:var(--transition); z-index:998; }
    #scrollTop.visible { opacity:1; visibility:visible; }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.97); backdrop-filter:blur(14px); z-index:2000; align-items:center; justify-content:center; padding:1.5rem; }
    .modal.active { display:flex; }
    .pdf-container { width:96%; max-width:1100px; height:93vh; background:#fff; border-radius:var(--radius); overflow:hidden; box-shadow:0 40px 90px rgba(0,48,135,0.5); position:relative; }

    #pdf-toolbar { position:absolute; top:0; left:0; right:0; background:rgba(0,0,0,0.9); backdrop-filter:blur(12px); padding:14px 20px; display:flex; align-items:center; gap:14px; z-index:11; color:white; font-size:1rem; border-radius:var(--radius) var(--radius) 0 0; }
    .pdf-control { background:rgba(255,255,255,0.2); color:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer; font-size:1.1rem; transition:all 0.3s; }
    .pdf-control:hover { background:var(--accent); transform:scale(1.1); }
    #pdf-canvas-container { width:100%; height:100%; overflow:auto; background:#222; display:flex; justify-content:center; align-items:flex-start; padding:70px 10px 20px; }
    #pdf-canvas { max-width:100%; box-shadow:0 10px 40px rgba(0,0,0,0.6); border-radius:8px; }
    #loading-message { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:white; font-size:1.5rem; background:rgba(0,0,0,0.8); padding:25px 50px; border-radius:20px; z-index:10; }

    @media (max-width:1200px) { .sidebar { width:260px; } body { padding-left:260px; } }
    @media (max-width:992px) { body { padding-left:0; } .sidebar { transform:translateX(-100%); transition:transform 0.45s ease; } .sidebar.active { transform:translateX(0); } .menu-toggle { display:block !important; } body.sidebar-open { overflow:hidden; } }
    .menu-toggle { display:none; position:fixed; top:20px; left:20px; z-index:1002; background:var(--primary); color:white; border:none; width:62px; height:62px; border-radius:50%; font-size:1.8rem; cursor:pointer; box-shadow:0 8px 25px rgba(0,48,135,0.5); }
  </style>
</head>
<body data-theme="light">

  <button class="menu-toggle" id="menu-toggle" aria-label="Menú">
    <i class="fas fa-bars"></i>
  </button>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <img src="Insignia-New-cuadrado.png" alt="IEP San Luis Gonzaga" class="sidebar-logo-big">
      <h2>Biblioteca<br><span>Sanluisina</span></h2>
    </div>
    <nav class="sidebar-nav">
      <a href="#" class="nav-item active" data-section="all"><i class="fas fa-home"></i> Todos los libros</a>
      <a href="#" class="nav-item" data-section="wol"><i class="fas fa-book-open"></i> Publicaciones Biblicos</a>
      <a href="#" class="nav-item" data-section="peru"><i class="fas fa-flag"></i> Literatura Peruana</a>
      <a href="#" class="nav-item" data-section="huanuco"><i class="fas fa-mountain"></i> Huánuco</a>
      <a href="#" class="nav-item" data-section="creencias-peru"><i class="fas fa-pray"></i> Creencias</a>
    </nav>
    <div class="sidebar-footer">
      <p>IEP San Luis Gonzaga<br><strong>Huánuco</strong></p>
    </div>
  </aside>

  <div class="controls">
    <button class="control-btn" id="theme-toggle"><i class="fas fa-moon"></i></button>
    <button class="control-btn" id="favorites-btn"><i class="fas fa-heart"></i><span id="fav-count">0</span></button>
  </div>

  <button id="scrollTop"><i class="fas fa-arrow-up"></i></button>

  <section class="hero">
    <div class="hero-content">
      <img src="Insignia-New-cuadrado.png" alt="IEP San Luis Gonzaga" class="hero-logo-big">
      <h1>Biblioteca Digital Sanluisina</h1>
      <p>IEP San Luis Gonzaga - Huánuco</p>
      <div class="search-bar">
        <input type="text" id="global-search" placeholder="Busca por título o autor" aria-label="Búsqueda"/>
      </div>
    </div>
  </section>

  <div class="container">
    <div class="stats">
      <div class="stat-item"><h3 id="total-books">0</h3><p>Libros</p></div>
      <div class="stat-item"><h3 id="total-authors">0</h3><p>Autores</p></div>
      <div class="stat-item"><h3 id="read-count">0</h3><p>Leídos</p></div>
    </div>

    <div class="filters">
      <div class="filter-group"><label for="filter-year">Año</label><select id="filter-year"><option value="">Todos</option></select></div>
      <div class="filter-group"><label for="filter-author">Autor</label><select id="filter-author"><option value="">Todos</option></select></div>
      <div class="filter-group"><label for="filter-category">Categoría</label><select id="filter-category"><option value="">Todas</option></select></div>
      <button id="clear-filters">Limpiar</button>
    </div>

    <div class="cards" id="all-container"></div>
  </div>

  <!-- MODAL PDF.js -->
  <div class="modal" id="pdf-modal">
    <div class="pdf-container">
      <div id="pdf-toolbar">
        <button id="prev-page" class="pdf-control"><i class="fas fa-chevron-left"></i></button>
        <span id="page-info">Página <span id="page-num">1</span> / <span id="page-count">1</span></span>
        <button id="next-page" class="pdf-control"><i class="fas fa-chevron-right"></i></button>
        <button id="zoom-out" class="pdf-control"><i class="fas fa-search-minus"></i></button>
        <button id="zoom-in" class="pdf-control"><i class="fas fa-search-plus"></i></button>
        <a id="download-pdf-btn" class="download-btn" style="margin-left:auto;padding:8px 16px;font-size:0.9rem;border-radius:12px;">
          <i class="fas fa-download"></i> Descargar
        </a>
        <button class="modal-close" aria-label="Cerrar">×</button>
      </div>
      <div id="pdf-canvas-container">
        <canvas id="pdf-canvas"></canvas>
      </div>
      <div id="loading-message">Cargando libro...</div>
    </div>
  </div>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.mjs" type="module"></script>
  <script type="module">
    import * as pdfjsLib from 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.mjs';
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.worker.min.mjs';

    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    let allBooks = [];
    let favorites = JSON.parse(localStorage.getItem('biblioteca_fav') || '[]');
    let readCount = parseInt(localStorage.getItem('biblioteca_read') || '0');
    let currentBooks = [];
    let currentView = 'all';

    const subCatNames = {
      'wol': 'Publicaciones WOL',
      'peru': 'Literatura Peruana',
      'huanuco': 'Literatura Huanuqueña',
      'creencias-peru': 'Creencias Peruanas',
      'creencias-huanuco': 'Creencias Huanuqueñas'
    };

    // Sanitización básica (equivalente a htmlspecialchars)
    const sanitize = str => String(str).replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    })[m]);

    const sanitizeBook = book => ({
      id: sanitize(book.id || ''),
      titulo: sanitize(book.titulo || ''),
      autor: sanitize(book.autor || ''),
      año: sanitize(book.año || ''),
      quote: sanitize(book.quote || ''),
      img: sanitize(book.img || ''),
      pdf: sanitize(book.pdf || ''),
      categoria: sanitize(book.categoria || '')
    });

    // Cargar JSON
    fetch('libros.json')
      .then(r => {
        if (!r.ok) throw new Error('No se encontró libros.json');
        return r.json();
      })
      .then(data => {
        const required = ['publicaciones_wol','literatura_peruana','literatura_huanuqueña','creencias_peruanas','creencias_huanuqueñas'];
        required.forEach(k => data[k] = data[k] || []);

        const catMap = {
          'publicaciones_wol': 'wol',
          'literatura_peruana': 'peru',
          'literatura_huanuqueña': 'huanuco',
          'creencias_peruanas': 'creencias-peru',
          'creencias_huanuqueñas': 'creencias-huanuco'
        };

        allBooks = [];
        for (const [key, cat] of Object.entries(catMap)) {
          (data[key] || []).forEach(book => {
            if (book.id) {
              book.categoria = cat;
              allBooks.push(sanitizeBook(book));
            }
          });
        }

        currentBooks = allBooks;
        initApp();
      })
      .catch(err => {
        $('#all-container').innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:5rem;color:var(--danger);"><h2>Error</h2><p>${err.message}</p></div>`;
      });

    function crearTarjeta(book) {
      const isFav = favorites.includes(book.id);
      const catName = subCatNames[book.categoria] || 'Otro';
      return `
        <div class="card" data-id="${book.id}" data-year="${book.año}" data-author="${book.autor}" data-cat="${book.categoria}">
          <button class="favorite-btn ${isFav ? 'active' : ''}"><i class="fas fa-heart"></i></button>
          <img src="${book.img}" alt="${book.titulo}" loading="lazy" onerror="this.src='https://via.placeholder.com/300x170/003087/white?text=${encodeURIComponent(book.titulo)}'">
          <div class="content">
            <div class="category-badge">${catName}</div>
            <h3>${book.titulo}</h3>
            <p>${book.autor} • ${book.año}</p>
            <p>"${book.quote}"</p>
            <div class="action-buttons">
              <button class="read-btn" data-pdf="${book.pdf}"><i class="fas fa-book-open"></i> Leer ahora</button>
              <a href="${book.pdf}" download class="download-btn"><i class="fas fa-download"></i> Descargar PDF</a>
            </div>
          </div>
        </div>`;
    }

    function renderizar(books, grouped = false) {
      const container = $('#all-container');
      if (!grouped) {
        container.innerHTML = books.length ? books.map(crearTarjeta).join('') : `<div style="grid-column:1/-1;text-align:center;padding:5rem;color:var(--gray);"><h3>No hay resultados</h3><p>Prueba otros filtros</p></div>`;
      } else {
        const groupedBooks = {};
        books.forEach(b => {
          const sub = subCatNames[b.categoria] || 'Otros';
          groupedBooks[sub] = groupedBooks[sub] || [];
          groupedBooks[sub].push(b);
        });
        let html = '';
        for (const [sub, list] of Object.entries(groupedBooks)) {
          if (list.length === 0) continue;
          html += `<h2 class="section-title">${sub}</h2>${list.map(crearTarjeta).join('')}`;
        }
        container.innerHTML = html || `<div style="grid-column:1/-1;text-align:center;padding:5rem;color:var(--gray);"><h3>No hay resultados</h3></div>`;
      }
      gsap.fromTo('.card', {y:50, opacity:0}, {y:0, opacity:1, stagger:0.1, duration:0.7, ease:"back.out(1.4)", onComplete: () => $$('.card').forEach(c => c.classList.add('visible'))});
      setupCardEvents();
    }

    function setupCardEvents() {
      $$('.favorite-btn').forEach(btn => {
        btn.onclick = e => {
          e.stopPropagation();
          const id = btn.closest('.card').dataset.id;
          if (favorites.includes(id)) {
            favorites = favorites.filter(f => f !== id);
            btn.classList.remove('active');
          } else {
            favorites.push(id);
            btn.classList.add('active');
            gsap.fromTo(btn, {scale:1}, {scale:1.3, duration:0.3, yoyo:true, repeat:1});
          }
          localStorage.setItem('biblioteca_fav', JSON.stringify(favorites));
          updateFavCount();
        };
      });
    }

    // PDF.js
    let pdfDoc = null, pageNum = 1, pageRendering = false, pageNumPending = null, scale = 1.5;
    const canvas = $('#pdf-canvas');
    const ctx = canvas.getContext('2d');

    function renderPage(num) {
      pageRendering = true;
      pdfDoc.getPage(num).then(page => {
        const viewport = page.getViewport({scale});
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        const renderContext = {canvasContext: ctx, viewport};
        const renderTask = page.render(renderContext);
        renderTask.promise.then(() => {
          pageRendering = false;
          if (pageNumPending !== null) { renderPage(pageNumPending); pageNumPending = null; }
        });
      });
      $('#page-num').textContent = num;
    }

    function initApp() {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const savedTheme = localStorage.getItem('biblioteca_theme');
      const isDark = savedTheme === 'dark' || (!savedTheme && prefersDark);
      document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
      $('#theme-toggle').innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';

      $('#total-books').textContent = allBooks.length;
      const authors = [...new Set(allBooks.map(b => b.autor))].sort();
      $('#total-authors').textContent = authors.length;
      $('#read-count').textContent = readCount;

      [...new Set(allBooks.map(b => b.año))].sort((a,b)=>b-a).forEach(y => $('#filter-year').add(new Option(y,y)));
      authors.forEach(a => $('#filter-author').add(new Option(a,a)));
      Object.entries(subCatNames).forEach(([k,v]) => $('#filter-category').add(new Option(v,k)));

      renderizar(allBooks);
      updateFavCount();

      // Eventos del menú
      $$('.nav-item').forEach(a => {
        a.onclick = e => {
          e.preventDefault();
          $$('.nav-item').forEach(l => l.classList.remove('active'));
          a.classList.add('active');
          const sec = a.dataset.section;
          currentView = sec;

          if (sec === 'all') {
            currentBooks = allBooks;
            renderizar(currentBooks, false);
          } else if (sec === 'peru') {
            currentBooks = allBooks.filter(b => ['peru','creencias-peru'].includes(b.categoria));
            renderizar(currentBooks, true);
          } else if (sec === 'huanuco') {
            currentBooks = allBooks.filter(b => ['huanuco','creencias-huanuco'].includes(b.categoria));
            renderizar(currentBooks, true);
          } else {
            currentBooks = allBooks.filter(b => b.categoria === sec);
            renderizar(currentBooks, true);
          }

          $('#filter-category').value = '';
          filterBooks();

          if (window.innerWidth <= 992) {
            $('.sidebar').classList.remove('active');
            document.body.classList.remove('sidebar-open');
          }
        };
      });

      $('#menu-toggle').onclick = () => {
        $('.sidebar').classList.toggle('active');
        document.body.classList.toggle('sidebar-open');
      };

      $('#theme-toggle').onclick = () => {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        const newTheme = isDark ? 'light' : 'dark';
        document.body.setAttribute('data-theme', newTheme);
        localStorage.setItem('biblioteca_theme', newTheme);
        $('#theme-toggle').innerHTML = newTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
      };

      $('#scrollTop').onclick = () => window.scrollTo({top:0, behavior:'smooth'});
      window.onscroll = () => $('#scrollTop').classList.toggle('visible', window.scrollY > 500);

      const filterBooks = () => {
        const q = $('#global-search').value.toLowerCase().trim();
        const y = $('#filter-year').value;
        const a = $('#filter-author').value;
        const c = $('#filter-category').value;

        let filtered = currentBooks.filter(b => {
          const matchQ = !q || [b.titulo, b.autor, b.quote].some(t => t.toLowerCase().includes(q));
          const matchY = !y || b.año == y;
          const matchA = !a || b.autor === a;
          const matchC = !c || b.categoria === c;
          return matchQ && matchY && matchA && matchC;
        });
        renderizar(filtered, currentView !== 'all');
      };

      $('#global-search').oninput = filterBooks;
      $('#filter-year,#filter-author,#filter-category').forEach(el => el.onchange = filterBooks);
      $('#clear-filters').onclick = () => {
        $('#global-search,#filter-year,#filter-author,#filter-category').forEach(el => el.value = '');
        renderizar(currentBooks, currentView !== 'all');
      };

      $('#favorites-btn').onclick = () => renderizar(allBooks.filter(b => favorites.includes(b.id)), false);

      // PDF viewer
      document.addEventListener('click', e => {
        if (e.target.closest('.read-btn')) {
          const btn = e.target.closest('.read-btn');
          const pdfUrl = btn.dataset.pdf;
          $('#download-pdf-btn').href = pdfUrl;
          $('#pdf-modal').classList.add('active');
          document.body.style.overflow = 'hidden';
          $('#loading-message').style.display = 'block';

          const loadingTask = pdfjsLib.getDocument(pdfUrl);
          loadingTask.promise.then(pdf => {
            pdfDoc = pdf;
            $('#page-count').textContent = pdf.numPages;
            pageNum = 1; scale = 1.5;
            $('#loading-message').style.display = 'none';
            renderPage(pageNum);
            readCount++;
            localStorage.setItem('biblioteca_read', readCount);
            $('#read-count').textContent = readCount;
          }).catch(() => {
            $('#loading-message').innerHTML = 'Error al cargar el PDF';
          });
        }
      });

      $('#prev-page').onclick = () => { if (pageNum > 1) { pageNum--; renderPage(pageNum); } };
      $('#next-page').onclick = () => { if (pageNum < pdfDoc.numPages) { pageNum++; renderPage(pageNum); } };
      $('#zoom-in').onclick = () => { scale += 0.3; renderPage(pageNum); };
      $('#zoom-out').onclick = () => { if (scale > 0.5) { scale -= 0.3; renderPage(pageNum); } };

      $('.modal-close').onclick = $('#pdf-modal').onclick = e => {
        if (e.target === $('#pdf-modal') || e.target === $('.modal-close')) {
          $('#pdf-modal').classList.remove('active');
          document.body.style.overflow = '';
          canvas.width = 1; canvas.height = 1;
        }
      };

      document.onkeydown = e => {
        if (e.key === 'Escape' && $('#pdf-modal').classList.contains('active')) $('.modal-close').click();
      };

      function updateFavCount() { $('#fav-count').textContent = favorites.length; }
    }
  </script>
</body>
</html>
