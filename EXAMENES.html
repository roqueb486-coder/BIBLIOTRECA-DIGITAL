<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banco de Exámenes - San Luis Gonzaga</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>
    <style>
        :root {
            --bg-dark: #0f172a;
            --surface: #1e293b;
            --text: #e2e8f0;
            --text-light: #94a3b8;
            --azul-marino: #1e40af;
            --amarillo: #fbbf24;
            --rojo: #dc2626;
            --border: #334155;
            --radius: 24px;
            --shadow: 0 15px 40px rgba(0,0,0,0.5);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text); min-height: 100vh; }

        .menu-toggle { position:fixed; top:20px; left:20px; z-index:1001; background:var(--azul-marino); color:white; border:none; width:60px; height:60px; border-radius:50%; font-size:1.8rem; cursor:pointer; box-shadow:0 8px 25px rgba(0,0,0,0.5); }
        .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); opacity:0; visibility:hidden; transition:all 0.4s; z-index:999; }
        .overlay.active { opacity:1; visibility:visible; }

        .sidebar { position:fixed; left:-300px; top:0; width:300px; height:100vh; background:linear-gradient(135deg,#0f172a,#1e293b); color:white; z-index:1000; transition:left 0.4s; box-shadow:5px 0 30px rgba(0,0,0,0.6); display:flex; flex-direction:column; }
        .sidebar.active { left:0; }
        .sidebar-header { padding:2rem; border-bottom:1px solid rgba(255,255,255,0.1); text-align:center; }
        .logo { width:130px; border-radius:50%; padding:1rem; background:rgba(251,0.2); border:4px solid var(--amarillo); margin-bottom:1rem; }
        .sidebar h2 { font-size:1.9rem; font-weight:900; }

        .nav-container { flex:1; overflow-y:auto; padding:1rem 0; }
        .nav a { display:block; padding:1.2rem 2rem; color:rgba(255,255,255,0.9); text-decoration:none; font-weight:600; transition:all 0.3s; }
        .nav a:hover { background:rgba(251,191,36,0.2); color:var(--amarillo); padding-left:2.5rem; }
        .nav a.volver { margin:0 2rem 2rem; background:var(--rojo); color:white!important; border-radius:20px; font-weight:900; font-size:1.1rem; padding:1.4rem; box-shadow:0 10px 30px rgba(220,38,38,0.5); order:-1; }

        .hero { height:100vh; min-height:600px; background:linear-gradient(rgba(15,23,42,0.95),rgba(15,23,42,0.85)), url('https://images.unsplash.com/photo-1523050858586-39f6d5e6b870?w=1920') center/cover; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:6rem 2rem 4rem; position:relative; }
        .hero h1 { font-size:clamp(3.8rem,9vw,8rem); font-weight:900; color:var(--amarillo); margin-bottom:1rem; }
        .hero p { font-size:1.7rem; color:var(--text-light); max-width:900px; }

        .container { max-width:1400px; margin:0 auto; padding:6rem 2rem 4rem; position:relative; z-index:2; margin-top:-100px; }

        .section-title { font-size:3.2rem; font-weight:900; color:var(--amarillo); margin:6rem 0 4rem; text-align:center; }
        .section-title::after { content:''; display:block; width:150px; height:8px; background:linear-gradient(90deg,var(--amarillo),var(--rojo)); margin:1rem auto; border-radius:4px; }

        .cards { display:grid; grid-template-columns:repeat(auto-fill,minmax(360px,1fr)); gap:3rem; justify-content:center; }
        .card { width:100%; max-width:380px; background:var(--surface); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); transition:transform 0.4s; }
        .card:hover { transform:translateY(-15px); }
        .card-img-container { height:220px; background:#000; display:flex; align-items:center; justify-content:center; overflow:hidden; }
        .card-img-container canvas { max-width:100%; max-height:100%; }
        .card-content { padding:2rem; text-align:center; }
        .badge { background:var(--azul-marino); color:white; padding:0.6rem 1.6rem; border-radius:50px; font-weight:700; font-size:0.85rem; display:inline-block; margin-bottom:1rem; }
        .card h3 { font-size:1.55rem; font-weight:800; color:white; margin:1rem 0; }
        .card p { color:var(--text-light); margin-bottom:1.5rem; }
        .btns { display:flex; justify-content:center; gap:1rem; }
        .btn { flex:1; padding:1rem; border-radius:16px; font-weight:700; font-size:0.95rem; text-decoration:none; transition:all 0.3s; }
        .btn-primary { background:var(--azul-marino); color:white; }
        .btn-success { background:var(--amarillo); color:#000; }
        .btn-danger { background:var(--rojo); color:white; }
        .btn:hover { transform:scale(1.05); }

        .upload-box { text-align:center; background:var(--surface); border:3px dashed var(--azul-marino); border-radius:var(--radius); padding:4rem 2rem; margin:7rem auto; max-width:900px; box-shadow:var(--shadow); }
        .upload-box h3 { font-size:2.3rem; font-weight:900; color:var(--amarillo); }
        .btn-upload { background:linear-gradient(135deg,var(--azul-marino),var(--amarillo)); color:white; padding:1.4rem 4rem; border:none; border-radius:50px; font-size:1.4rem; font-weight:900; cursor:pointer; margin-top:1.5rem; box-shadow:var(--shadow); }
        .btn-upload:hover { transform:translateY(-6px) scale(1.08); }

        .modal { position:fixed; inset:0; background:rgba(15,23,42,0.97); backdrop-filter:blur(12px); display:none; justify-content:center; align-items:center; z-index:9999; }
        .modal-content { background:var(--surface); border-radius:var(--radius); padding:3rem; max-width:560px; width:95%; text-align:center; box-shadow:var(--shadow); position:relative; }
        .modal h3 { font-size:2.2rem; color:var(--amarillo); margin-bottom:2rem; font-weight:800; }
        #examTitle { width:100%; padding:1.2rem; border-radius:16px; border:none; background:#334155; color:white; font-size:1.1rem; margin-bottom:2rem; text-align:center; }
        .file-input { display:block; background:#fef3c7; border:3px dashed var(--azul-marino); border-radius:20px; padding:2.8rem 2rem; cursor:pointer; margin:2rem auto; font-weight:700; color:#000; font-size:1.1rem; max-width:420px; }
        #fileInfo { color:var(--amarillo); font-weight:700; margin:1.5rem 0; font-size:1.1rem; }
        #uploadBtn { background:linear-gradient(135deg,var(--azul-marino),var(--amarillo)); color:white; padding:1.4rem; border:none; border-radius:50px; font-size:1.4rem; font-weight:900; cursor:pointer; width:100%; margin-top:1rem; box-shadow:var(--shadow); }
        .progress { height:16px; background:var(--border); border-radius:8px; overflow:hidden; margin-top:1.5rem; display:none; }
        .progress-bar { height:100%; background:linear-gradient(90deg,var(--azul-marino),var(--amarillo)); width:0%; transition:width 0.6s; }
        .close { position:absolute; top:1rem; right:1.5rem; font-size:2.8rem; cursor:pointer; color:var(--text-light); }
        .empty { text-align:center; padding:5rem; color:var(--text-light); font-size:1.4rem; }
    </style>
</head>
<body>

    <button class="menu-toggle" onclick="toggleMenu()">Menu Icon</button>
    <div class="overlay" onclick="toggleMenu()"></div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="Insignia-New-cuadrado.png" alt="Logo" class="logo" onerror="this.style.display='none'">
            <h2>Banco de<br>Exámenes</h2>
        </div>
        <div class="nav-container">
            <nav class="nav">
                <a href="index.html" class="volver">Volver a Biblioteca</a>
                <a href="#inicio">Inicio</a>
                <a href="#area1">Área I</a>
                <a href="#area2">Área II</a>
                <a href="#area3">Área III</a>
                <a href="#area4">Área IV</a>
                <a href="#area5">Área V</a>
                <a href="#area6">Concursos Interescolares</a>
            </nav>
        </div>
    </aside>

    <section class="hero" id="inicio">
        <h1>BANCO DE EXÁMENES</h1>
        <p>Comparte y descarga exámenes organizados por áreas • Incluye Concursos Interescolares</p>
    </section>

    <div class="container" id="main-container">
        <!-- Aquí se genera todo automáticamente -->
    </div>

    <!-- MODAL SUBIR -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">x</span>
            <h3 id="modalTitle">Subir archivo</h3>
            <input type="text" id="examTitle" placeholder="Ej: Olimpiada Matemática 2025">
            <label class="file-input" for="fileInput">Máximo 140MB • Solo PDF</label>
            <input type="file" id="fileInput" accept=".pdf" style="display:none;">
            <div id="fileInfo"></div>
            <button id="uploadBtn" class="btn-upload">SUBIR ARCHIVO</button>
            <div class="progress" id="progress"><div class="progress-bar" id="progressBar"></div></div>
        </div>
    </div>

    <script type="module">
        import * as pdfjsLib from 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.mjs';
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.worker.min.mjs';

        let db;
        const request = indexedDB.open('BancoExamenes', 1);
        request.onupgradeneeded = e => {
            db = e.target.result;
            db.createObjectStore('examenes', {keyPath: 'id'});
            db.createObjectStore('files', {keyPath: 'id'});
        };
        request.onsuccess = e => { db = e.target.result; iniciar(); };

        const areas = ['area1','area2','area3','area4','area5','area6'];
        const nombres = ['Área I','Área II','Área III','Área IV','Área V','Concursos Interescolares'];
        let examenes = [];

        async function iniciar() {
            await cargarExamenes();
            generarSecciones();
        }

        async function cargarExamenes() {
            const tx = db.transaction('examenes');
            examenes = await tx.objectStore('examenes').getAll();
            for (let ex of examenes) {
                const tx2 = db.transaction('files');
                const fileObj = await tx2.objectStore('files').get(ex.id);
                if (fileObj) ex.pdfUrl = URL.createObjectURL(fileObj.file);
            }
            examenes.sort((a,b) => b.fecha_unix - a.fecha_unix);
        }

        function generarSecciones() {
            const cont = document.getElementById('main-container');
            cont.innerHTML = '';

            areas.forEach((area, i) => {
                const lista = examenes.filter(e => e.area === area);

                cont.innerHTML += `<h2 class="section-title" id="${area}">${nombres[i]}</h2>`;

                const cards = document.createElement('div');
                cards.className = 'cards';

                if (lista.length === 0) {
                    cards.innerHTML = '<p class="empty">Aún no hay archivos en esta sección</p>';
                } else {
                    lista.forEach(ex => {
                        cards.innerHTML += `
                            <div class="card" data-id="${ex.id}">
                                <div class="card-img-container"><canvas id="pdf-${ex.id}"></canvas></div>
                                <div class="card-content">
                                    <div class="badge">${nombres[i]}</div>
                                    <h3>${ex.titulo}</h3>
                                    <p>${ex.fecha}</p>
                                    <div class="btns">
                                        <a href="${ex.pdfUrl}" target="_blank" class="btn btn-primary">Ver</a>
                                        <a href="${ex.pdfUrl}" download="${ex.titulo}.pdf" class="btn btn-success">Descargar</a>
                                        <button onclick="eliminar('${ex.id}',this)" class="btn btn-danger">Eliminar</button>
                                    </div>
                                </div>
                            </div>`;
                        lista.forEach(ex => renderPreview(ex.pdfUrl, `pdf-${ex.id}`));
                    });
                }
                cont.appendChild(cards);

                const box = document.createElement('div');
                box.className = 'upload-box';
                box.innerHTML = `<h3>¿Tienes archivos de ${nombres[i]}?</h3>
                                 <p>Sube y ayuda a tus compañeros</p>
                                 <button class="btn-upload" onclick="abrirModal('${area}')">SUBIR AHORA</button>`;
                cont.appendChild(box);
            });
        }

        function renderPreview(url, canvasId) {
            pdfjsLib.getDocument(url).promise.then(pdf => pdf.getPage(1)).then(page => {
                const canvas = document.getElementById(canvasId);
                const viewport = page.getViewport({scale: 1.5});
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                page.render({canvasContext: canvas.getContext('2d'), viewport});
            }).catch(() => {});
        }

        let areaActual = '';
        window.abrirModal = function(area) {
            areaActual = area;
            const nom = area==='area6' ? 'Concursos Interescolares' : 'Área '+area.slice(4);
            document.getElementById('modalTitle').textContent = 'Subir a '+nom;
            document.getElementById('modal').style.display = 'flex';
        };
        window.closeModal = () => document.getElementById('modal').style.display = 'none';

        document.getElementById('fileInput').onchange = e => {
            const f = e.target.files[0];
            if (f) document.getElementById('fileInfo').textContent = `${f.name} (${(f.size/1024/1024).toFixed(1)} MB)`;
        };

        document.getElementById('uploadBtn').onclick = async () => {
            const titulo = document.getElementById('examTitle').value.trim();
            const file = document.getElementById('fileInput').files[0];
            if (!titulo || !file || file.size > 140*1024*1024) return alert('Error en los datos');

            const id = 'exam_'+Date.now();
            const fecha = new Date();
            const nuevo = {
                id, titulo,
                area: areaActual,
                fecha: fecha.toLocaleDateString('es-ES')+' '+fecha.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}),
                fecha_unix: fecha.getTime()
            };

            const tx = db.transaction(['examenes','files'],'readwrite');
            tx.objectStore('examenes').add(nuevo);
            tx.objectStore('files').add({id, file});
            await tx.done;

            closeModal();
            document.getElementById('examTitle').value = '';
            document.getElementById('fileInput').value = '';
            iniciar(); // recarga todo
            alert('¡Subido con éxito!');
        };

        window.eliminar = async (id, btn) => {
            if (!confirm('¿Eliminar permanentemente?')) return;
            const card = btn.closest('.card');
            const tx = db.transaction(['examenes','files'],'readwrite');
            tx.objectStore('examenes').delete(id);
            tx.objectStore('files').delete(id);
            await tx.done;
            gsap.to(card,{y:-60, opacity:0, duration:0.6, onComplete:()=>card.remove()});
        };

        window.toggleMenu = () => {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        };

        window.onclick = e => { if (e.target.id==='modal') closeModal(); };
    </script>
</body>
</html>
